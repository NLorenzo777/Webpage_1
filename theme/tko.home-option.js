function fRebuildIndex(obj, iStep){
  if($bProduction){
    //0 - the script must be invoked
    //1 - the script has just been invoked
    //2 - the old tko.index.clr was just deleted
    //3 - a new tko.index.clr was successfully generated
    if(iStep==0){
      //run the TKO.HOME script, then disable the controls in the Options window
      //signal that TKO.HOME script has been invoked
      top.location.href = "vbs/tko.home.exe";
      $(obj).removeAttr('onclick')             
        .css('cursor', 'default')
        .attr('src', 'theme/graphic/cue_loading.gif');
      $('.modal-actionset > input')            
        .attr('value',"Rebuilding, please wait    ...")
        .attr('disabled', 'true');
      fRebuildIndex(obj, 1); }
    else if(iStep==1){
      //detect if tko.index.clr exists, and loop until it goes missing
      //when file goes missing, signal that it has been deleted 
      $.get('vbs/tko.index.clr', function(){
        fRebuildIndex(obj, 1); })
        .fail(function(){                      
          setTimeout(function(){
            fRebuildIndex(obj, 2) }, 1000);    
        })}
    else if(iStep==2){
      //detect if tko.index.clr exists, and loop until it is found
      //when tko.index.clr is determined to exist, signal that is has been regenerated
      $.get('vbs/tko.index.clr', function(){   
         objPrepDelay = 4
         objPrepIndex = setInterval(fPreptoRefreshIndex, 1000);
         setTimeout(function(){
           fRebuildIndex(obj, 3) }, 5000); })
        .fail(function(){                      
          setTimeout(function(){
            fRebuildIndex(obj, 2) }, 1000);    
        })}
    else if(iStep==3){
      $(obj).attr('src', 'theme/graphic/ico_rebuild.png');
      alert("Rebuilding the TKO menu is complete!  Click OK to refresh.");
      top.location.href = top.location.href;
    }
  }
  else{
    alert("This command only runs in production environment.");
  }  
}

function fPreptoRefreshIndex(){
  $('.modal-actionset > input').attr('value',"Rebuilding, please wait (" + objPrepDelay + " secs)   ...");
  objPrepDelay = objPrepDelay - 1;  
}

function fRestartUpdater(obj, iStep){
  if($bProduction){
    //check for tko.service.clr
    //if clr doesn't exist, wait for it to generated by tko.home.exe
    //when clr is detected, display the "result" text (from the clr)
    iStep == 0 ? top.location.href = "vbs/tko.service.exe" : null;
    
    $(obj).removeAttr('onclick')
      .css('cursor', 'default')
      .attr('src', 'theme/graphic/cue_loading.gif');
      
    $('.modal-actionset > input')
      .attr('value',"Restarting, please wait    ...")
      .attr('disabled', 'true');
    
    $.get('vbs/tko.service.clr', function(data){
      if(data.documentElement){
        var cXmlRoot = data.documentElement
        var cXmlClass = cXmlRoot.tagName;
        var cXmlTree = new Array();
        $(cXmlRoot.childNodes).each(function(i,e){
          e.tagName ? cXmlTree.push(e) : null; }); }
      else{
        var cXmlTree = $($.parseXML(data)).children()[0].childNodes
        var cXmlClass = $($.parseXML(data)).children()[0].tagName;
      }
      
      $(cXmlTree).each(function(i, o){alert($(o).text())});
      
      $(obj).css('cursor', 'pointer')
        .attr('onclick', 'fRestartUpdater(this, 0)')
        .attr('src', 'theme/graphic/ico_refresh.png');

      $('.modal-actionset > input')
        .attr('value',"Close")
        .removeAttr('disabled');
    
    }).fail(function(){
      setTimeout(function(){
        fRestartUpdater(obj, 1)
      }, 1000);
    })    
  }
  else{
    alert("This command only runs in production environment.");
  }  
}

function fChangeLanguage(lang){
    switch(lang){
        case 'eng':
        var bLoc = bProduction ? "download.htm" : "default.htm";
        top.location.href=bLoc;
        $.jStorage.flush();
        break;
        
        case 'chn':
        top.location.href="chn.htm";
        $.jStorage.set("lang_home", "chn")
        break
    }
}

function fCheckLanguage() {
    var lang_store = $.jStorage.get("lang_home")
    
    switch(lang_store){
      case "chn":
      top.location.href="chn.htm";
      break;
      
      default:
      break;
      
    }
    
    $(document).keydown(function(e) {
    if (e.keyCode == 27) { //ESC
        var bLoc = bProduction ? "download.htm" : "default.htm";
        $.jStorage.flush()
        top.location.href=bLoc;
    }
});
    
}